<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AP BOT</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      background: #f6f7f9;
      color: #111;
    }
    header {
      padding: 12px 20px;
      background: #ffffff;
      border-bottom: 1px solid #e6e8ee;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }
    header p {
      margin: 4px 0 0 0;
      font-size: 12px;
      color: #555;
      line-height: 1.5;
    }
    main {
      padding: 8px 20px;
      max-width: 900px;
      margin: 0 auto;
    }
    #status-text {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
      min-height: 1.4em;
    }

    /* Dify バブルの色やサイズを調整 */
    #dify-chatbot-bubble-button {
      background-color: #1C64F2 !important;
    }
    #dify-chatbot-bubble-window {
      width: 24rem !important;
      height: 40rem !important;
    }
  </style>
</head>
<body>
  <header>
    <h1>AP BOT</h1>
    <p>右下のボタンからチャットボットを利用できます。</p>
    <div id="status-text"></div>
  </header>

  <main>
    <!-- プレゼン用なので本体の説明は何も置かない -->
  </main>

  <script>
    // 必要ならここにデフォルト値を入れる
    // クイックトンネルを毎回張り直すなら空のままにして、
    // ap-config 側の localStorage 設定だけ使う運用でもよい
    const DEFAULT_BASE_URL = "";
    const DEFAULT_TOKEN = "";
    const DEFAULT_SCRIPT_PATH = "/embed.min.js";

    function setStatus(text) {
      var el = document.getElementById("status-text");
      if (el) el.textContent = text;
    }

    function normalizeBaseUrl(url) {
      if (!url) return "";
      url = url.trim();
      url = url.replace(/\/+$/, "");
      return url;
    }

    function normalizeScriptPath(path) {
      if (!path) return "/embed.min.js";
      path = path.trim();
      if (!path.startsWith("/")) path = "/" + path;
      return path;
    }

    function removeExistingEmbedScripts() {
      var olds = document.querySelectorAll('script[data-dify-embed="1"]');
      olds.forEach(function (el) {
        el.remove();
      });
    }

    function loadSettingsFromLocalStorage() {
      var baseUrl = localStorage.getItem("ap_demo_baseUrl") || "";
      var token = localStorage.getItem("ap_demo_token") || "";
      var scriptPath = localStorage.getItem("ap_demo_scriptPath") || "";

      if (!baseUrl && DEFAULT_BASE_URL) baseUrl = DEFAULT_BASE_URL;
      if (!token && DEFAULT_TOKEN) token = DEFAULT_TOKEN;
      if (!scriptPath) scriptPath = DEFAULT_SCRIPT_PATH;

      return { baseUrl: baseUrl, token: token, scriptPath: scriptPath };
    }

    function loadEmbed(baseUrl, token, scriptPath) {
      baseUrl = normalizeBaseUrl(baseUrl);
      scriptPath = normalizeScriptPath(scriptPath);

      if (!baseUrl || !token) {
        setStatus("設定がありません。ap-config 側でトンネルURLとトークンを保存してください。");
        console.error("baseUrl または token が空です。");
        return;
      }

      var scriptUrl = baseUrl + scriptPath;

      window.difyChatbotConfig = {
        token: token,
        baseUrl: baseUrl,
        inputs: {},
        systemVariables: {},
        userVariables: {}
      };

      removeExistingEmbedScripts();

      var s = document.createElement("script");
      s.setAttribute("data-dify-embed", "1");
      s.id = token;
      s.src = scriptUrl;
      s.defer = true;
      s.referrerPolicy = "no-referrer";

      s.onload = function () {
        setStatus("チャットボット接続に成功しました。");
        console.log("Dify embed loaded", scriptUrl);
      };

      s.onerror = function () {
        setStatus("チャットボットの読み込みに失敗しました。Dify とトンネルURLを確認してください。");
        console.error("Dify embed script load failed", scriptUrl);
      };

      document.body.appendChild(s);
    }

    document.addEventListener("DOMContentLoaded", function () {
      var s = loadSettingsFromLocalStorage();
      if (!s.baseUrl && !s.token && !DEFAULT_BASE_URL && !DEFAULT_TOKEN) {
        setStatus("設定がないためチャットボットを起動できません。");
        return;
      }
      loadEmbed(s.baseUrl, s.token, s.scriptPath);
    });
  </script>
</body>
</html>

<script>
 window.difyChatbotConfig = {
  token: 'ZDPHnH6mn8ISpPTh',
  baseUrl: 'http://localhost',
  inputs: {
    // You can define the inputs from the Start node here
    // key is the variable name
    // e.g.
    // name: "NAME"
  },
  systemVariables: {
    // user_id: 'YOU CAN DEFINE USER ID HERE',
    // conversation_id: 'YOU CAN DEFINE CONVERSATION ID HERE, IT MUST BE A VALID UUID',
  },
  userVariables: {
    // avatar_url: 'YOU CAN DEFINE USER AVATAR URL HERE',
    // name: 'YOU CAN DEFINE USER NAME HERE',
  },
 }
</script>
<script
 src="http://localhost/embed.min.js"
 id="ZDPHnH6mn8ISpPTh"
 defer>
</script>
<style>
  #dify-chatbot-bubble-button {
    background-color: #1C64F2 !important;
  }
  #dify-chatbot-bubble-window {
    width: 24rem !important;
    height: 40rem !important;
  }
</style>
