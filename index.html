<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AP BOT デモ</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      background: #f6f7f9;
      color: #111;
    }
    header {
      padding: 16px 20px;
      background: #ffffff;
      border-bottom: 1px solid #e6e8ee;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
    }
    header p {
      margin: 6px 0 0 0;
      font-size: 13px;
      color: #444;
      line-height: 1.5;
    }
    main {
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
    }
    .card {
      background: #ffffff;
      border: 1px solid #e6e8ee;
      border-radius: 12px;
      padding: 18px 16px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
      margin-bottom: 16px;
    }
    .card h2 {
      margin: 0 0 8px 0;
      font-size: 16px;
    }
    .card p {
      margin: 4px 0;
      font-size: 14px;
      line-height: 1.7;
      color: #333;
    }
    .note {
      font-size: 12px;
      color: #555;
      line-height: 1.6;
      background: #ffffff;
      border: 1px solid #e6e8ee;
      border-radius: 12px;
      padding: 12px 14px;
    }
    code {
      background: #f0f2f6;
      padding: 2px 6px;
      border-radius: 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }

    /* Dify バブルの色やサイズを調整 */
    #dify-chatbot-bubble-button {
      background-color: #1C64F2 !important;
    }
    #dify-chatbot-bubble-window {
      width: 24rem !important;
      height: 40rem !important;
    }
  </style>
</head>
<body>
  <header>
    <h1>AP BOT デモ</h1>
    <p>右下のボタンから、ローカル Dify を使ったチャットボットに接続します。</p>
  </header>

  <main>
    <div class="card" id="info-card">
      <h2>デモ用ページ</h2>
      <p>このページは、設定済みの Dify 埋め込み情報を使ってチャットボットを起動します。</p>
      <p>右下にチャットボタンが出ていれば、接続成功です。</p>
      <p id="status-text" style="font-size:13px; color:#555; margin-top:8px;"></p>
    </div>

    <div class="note">
      <div>事前準備</div>
      <div>1 Dify と Cloudflare Quick Tunnel を起動しておく</div>
      <div>2 <code>/ap-config.html</code> を開き、トンネルURLとトークンを保存しておく</div>
      <div>3 本番ではこのページ（トップページ）だけを表示する</div>
    </div>
  </main>

  <script>
    // 必要ならここにデフォルト値を入れる（なくても動く）
    // const DEFAULT_BASE_URL = "https://xxxxx.trycloudflare.com";
    // const DEFAULT_TOKEN = "ここに Dify の埋め込みトークン";
    // const DEFAULT_SCRIPT_PATH = "/embed.min.js";

    const DEFAULT_BASE_URL = "";
    const DEFAULT_TOKEN = "";
    const DEFAULT_SCRIPT_PATH = "/embed.min.js";

    function setStatus(text) {
      var el = document.getElementById("status-text");
      if (el) el.textContent = text;
    }

    function normalizeBaseUrl(url) {
      if (!url) return "";
      url = url.trim();
      url = url.replace(/\/+$/, "");
      return url;
    }

    function normalizeScriptPath(path) {
      if (!path) return "/embed.min.js";
      path = path.trim();
      if (!path.startsWith("/")) path = "/" + path;
      return path;
    }

    function removeExistingEmbedScripts() {
      var olds = document.querySelectorAll('script[data-dify-embed="1"]');
      olds.forEach(function (el) {
        el.remove();
      });
    }

    function loadSettingsFromLocalStorage() {
      var baseUrl = localStorage.getItem("ap_demo_baseUrl") || "";
      var token = localStorage.getItem("ap_demo_token") || "";
      var scriptPath = localStorage.getItem("ap_demo_scriptPath") || "";

      if (!baseUrl && DEFAULT_BASE_URL) baseUrl = DEFAULT_BASE_URL;
      if (!token && DEFAULT_TOKEN) token = DEFAULT_TOKEN;
      if (!scriptPath) scriptPath = DEFAULT_SCRIPT_PATH;

      return { baseUrl: baseUrl, token: token, scriptPath: scriptPath };
    }

    function loadEmbed(baseUrl, token, scriptPath) {
      baseUrl = normalizeBaseUrl(baseUrl);
      scriptPath = normalizeScriptPath(scriptPath);

      if (!baseUrl || !token) {
        setStatus("設定が見つかりません。ap-config.html でトンネルURLとトークンを保存してください。");
        console.error("baseUrl または token が空です。");
        return;
      }

      var scriptUrl = baseUrl + scriptPath;

      window.difyChatbotConfig = {
        token: token,
        baseUrl: baseUrl,
        inputs: {},
        systemVariables: {},
        userVariables: {}
      };

      removeExistingEmbedScripts();

      var s = document.createElement("script");
      s.setAttribute("data-dify-embed", "1");
      s.id = token;
      s.src = scriptUrl;
      s.defer = true;
      s.referrerPolicy = "no-referrer";

      s.onload = function () {
        setStatus("チャットボットの読み込みに成功しました。右下のボタンから会話を開始できます。");
        console.log("Dify embed loaded", scriptUrl);
      };

      s.onerror = function () {
        setStatus("チャットボットの読み込みに失敗しました。Dify / トンネルURL / パスを確認してください。");
        console.error("Dify embed script load failed", scriptUrl);
      };

      document.body.appendChild(s);
    }

    document.addEventListener("DOMContentLoaded", function () {
      var s = loadSettingsFromLocalStorage();
      if (!s.baseUrl && !s.token && !DEFAULT_BASE_URL && !DEFAULT_TOKEN) {
        setStatus("まだ設定がありません。まず ap-config.html でトンネルURLとトークンを保存してください。");
        return;
      }
      loadEmbed(s.baseUrl, s.token, s.scriptPath);
    });
  </script>
</body>
</html>
