<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AP BOT デモ</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      background: #f6f7f9;
      color: #111;
    }
    header {
      padding: 16px 20px;
      background: #ffffff;
      border-bottom: 1px solid #e6e8ee;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }
    header p {
      margin: 6px 0 0 0;
      font-size: 13px;
      color: #444;
      line-height: 1.5;
    }
    main {
      padding: 16px 20px 24px 20px;
      max-width: 1100px;
      margin: 0 auto;
    }
    .card {
      background: #ffffff;
      border: 1px solid #e6e8ee;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
      padding: 16px;
      margin-bottom: 12px;
    }
    .row {
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: 10px;
      align-items: center;
      margin: 10px 0;
    }
    label {
      font-size: 13px;
      color: #333;
    }
    input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d7dbe6;
      border-radius: 10px;
      font-size: 14px;
      background: #fff;
      box-sizing: border-box;
    }
    .btns {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    button {
      appearance: none;
      border: 1px solid #d7dbe6;
      background: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
    }
    button.primary {
      border-color: #1C64F2;
    }
    .note {
      font-size: 12px;
      color: #555;
      line-height: 1.6;
      background: #ffffff;
      border: 1px solid #e6e8ee;
      border-radius: 12px;
      padding: 12px 14px;
    }
    code {
      background: #f0f2f6;
      padding: 2px 6px;
      border-radius: 6px;
    }
    .status {
      font-size: 13px;
      line-height: 1.6;
      color: #111;
    }
    .status small {
      color: #555;
    }
  </style>
</head>
<body>
  <header>
    <h1>AP BOT デモ</h1>
    <p>ローカルDifyをCloudflare Quick TunnelでHTTPS公開し、このページから埋め込み起動します。</p>
  </header>

  <main>
    <div class="card">
      <div class="status" id="status">
        状態: 未設定。下のフォームにトンネルURLとトークンを入れてください。
        <br><small>注意: PowerShellでcloudflaredを起動したままにしてください。閉じると公開が止まります。</small>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <label for="baseUrl">トンネルURL</label>
        <input id="baseUrl" type="text" placeholder="例: https://xxxxx.trycloudflare.com" />
      </div>

      <div class="row">
        <label for="token">埋め込みトークン</label>
        <input id="token" type="text" placeholder="例: ZDPHnH6mn8ISpPTh" />
      </div>

      <div class="row">
        <label for="scriptPath">embedのパス</label>
        <input id="scriptPath" type="text" value="/embed.min.js" />
      </div>

      <div class="btns">
        <button class="primary" id="saveAndStart">保存して起動</button>
        <button id="testScript">JS到達テスト</button>
        <button id="openScript">JSを別タブで開く</button>
        <button id="clear">クリア</button>
      </div>

      <div class="note" style="margin-top:12px;">
        <div>手順</div>
        <div>1) PowerShellで <code>cloudflared tunnel --url http://localhost:80</code> を起動</div>
        <div>2) 表示された <code>https://xxxxx.trycloudflare.com</code> を「トンネルURL」に貼る</div>
        <div>3) ローカルDifyの「公開する」→「埋め込み」で token を貼る</div>
        <div>4) 「保存して起動」</div>
        <div style="margin-top:8px;">embedのパスが <code>/embed.min.js</code> でない場合は、Difyの埋め込みコードに出るscriptのパスをそのまま入れてください。</div>
      </div>
    </div>

    <div class="note">
      <div>現実</div>
      <div>GitHub Pagesから <code>http://localhost</code> には届きません。必ずトンネルの <code>https://...</code> が必要です。</div>
      <div>デモ後はトークンを再発行して無効化してください（公開ページにトークンが載るため）。</div>
    </div>
  </main>

  <script>
    function normalizeBaseUrl(url) {
      if (!url) return "";
      url = url.trim();
      url = url.replace(/\/+$/, "");
      return url;
    }

    function normalizeScriptPath(path) {
      if (!path) return "/embed.min.js";
      path = path.trim();
      if (!path.startsWith("/")) path = "/" + path;
      return path;
    }

    function setStatus(html) {
      document.getElementById("status").innerHTML = html;
    }

    function removeExistingEmbedScripts() {
      var olds = document.querySelectorAll('script[data-dify-embed="1"]');
      olds.forEach(function (el) {
        el.remove();
      });
    }

    function loadEmbed(baseUrl, token, scriptPath) {
      baseUrl = normalizeBaseUrl(baseUrl);
      scriptPath = normalizeScriptPath(scriptPath);

      if (!baseUrl || !token) {
        setStatus("状態: 設定不足。トンネルURLとトークンを入力してください。");
        return;
      }

      var scriptUrl = baseUrl + scriptPath;

      window.difyChatbotConfig = {
        token: token,
        baseUrl: baseUrl,
        inputs: {},
        systemVariables: {},
        userVariables: {}
      };

      removeExistingEmbedScripts();

      var s = document.createElement("script");
      s.setAttribute("data-dify-embed", "1");

      // 重要: Difyの埋め込みは scriptタグの id に token を置く実装が多い
      s.id = token;

      s.src = scriptUrl;
      s.defer = true;
      s.referrerPolicy = "no-referrer";

      s.onload = function () {
        setStatus(
          "状態: embedスクリプト読み込み成功。右下にボタンが出るはずです。<br>" +
          "<small>baseUrl: <code>" + baseUrl + "</code><br>script: <code>" + scriptUrl + "</code><br>token: <code>" + token + "</code></small>"
        );
      };

      s.onerror = function () {
        setStatus(
          "状態: embedスクリプト読み込み失敗。URLかパスが違うか、ブラウザがブロックしています。<br>" +
          "<small>script: <code>" + scriptUrl + "</code></small><br>" +
          "<small>対策: 1) 「JSを別タブで開く」で表示できるか 2) Difyの埋め込みコードに出るパスと一致しているか 3) トンネルが生きているか</small>"
        );
      };

      document.body.appendChild(s);
    }

    function saveSettings() {
      var baseUrl = document.getElementById("baseUrl").value;
      var token = document.getElementById("token").value;
      var scriptPath = document.getElementById("scriptPath").value;
      localStorage.setItem("ap_demo_baseUrl", baseUrl);
      localStorage.setItem("ap_demo_token", token);
      localStorage.setItem("ap_demo_scriptPath", scriptPath);
    }

    function loadSettings() {
      var baseUrl = localStorage.getItem("ap_demo_baseUrl") || "";
      var token = localStorage.getItem("ap_demo_token") || "";
      var scriptPath = localStorage.getItem("ap_demo_scriptPath") || "/embed.min.js";
      document.getElementById("baseUrl").value = baseUrl;
      document.getElementById("token").value = token;
      document.getElementById("scriptPath").value = scriptPath;
      return { baseUrl: baseUrl, token: token, scriptPath: scriptPath };
    }

    // CORSで誤判定しないため、no-corsで「到達できるか」だけ見る
    function testScriptReachability(baseUrl, scriptPath) {
      baseUrl = normalizeBaseUrl(baseUrl);
      scriptPath = normalizeScriptPath(scriptPath);
      if (!baseUrl) {
        setStatus("状態: トンネルURLが空です。");
        return;
      }
      var scriptUrl = baseUrl + scriptPath;

      fetch(scriptUrl, { method: "GET", mode: "no-cors", cache: "no-store" })
        .then(function () {
          setStatus(
            "状態: JS到達テストOK（no-cors）。<br>" +
            "<small>script: <code>" + scriptUrl + "</code><br>補足: no-corsのため中身は検査できません。次に「保存して起動」を押してください。</small>"
          );
        })
        .catch(function (e) {
          setStatus(
            "状態: JS到達テスト失敗（ネットワーク到達不可）。<br>" +
            "<small>script: <code>" + scriptUrl + "</code></small><br>" +
            "<small>エラー: " + String(e) + "</small>"
          );
        });
    }

    function openScriptInNewTab(baseUrl, scriptPath) {
      baseUrl = normalizeBaseUrl(baseUrl);
      scriptPath = normalizeScriptPath(scriptPath);
      if (!baseUrl) {
        setStatus("状態: トンネルURLが空です。");
        return;
      }
      var scriptUrl = baseUrl + scriptPath;
      window.open(scriptUrl, "_blank", "noopener,noreferrer");
    }

    document.getElementById("saveAndStart").addEventListener("click", function () {
      saveSettings();
      var s = loadSettings();
      loadEmbed(s.baseUrl, s.token, s.scriptPath);
    });

    document.getElementById("testScript").addEventListener("click", function () {
      var baseUrl = document.getElementById("baseUrl").value;
      var scriptPath = document.getElementById("scriptPath").value;
      testScriptReachability(baseUrl, scriptPath);
    });

    document.getElementById("openScript").addEventListener("click", function () {
      var baseUrl = document.getElementById("baseUrl").value;
      var scriptPath = document.getElementById("scriptPath").value;
      openScriptInNewTab(baseUrl, scriptPath);
    });

    document.getElementById("clear").addEventListener("click", function () {
      localStorage.removeItem("ap_demo_baseUrl");
      localStorage.removeItem("ap_demo_token");
      localStorage.removeItem("ap_demo_scriptPath");
      document.getElementById("baseUrl").value = "";
      document.getElementById("token").value = "";
      document.getElementById("scriptPath").value = "/embed.min.js";
      setStatus("状態: クリアしました。再入力してください。");
      removeExistingEmbedScripts();
    });

    (function init() {
      var s = loadSettings();
      if (s.baseUrl && s.token) {
        loadEmbed(s.baseUrl, s.token, s.scriptPath);
      }
    })();
  </script>

  <style>
    #dify-chatbot-bubble-button {
      background-color: #1C64F2 !important;
    }
    #dify-chatbot-bubble-window {
      width: 24rem !important;
      height: 40rem !important;
    }
  </style>
</body>
</html>
